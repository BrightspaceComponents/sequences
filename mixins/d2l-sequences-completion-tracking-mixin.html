<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-polymer-siren-behaviors/store/entity-behavior.html">
<link rel="import" href="../../d2l-polymer-siren-behaviors/store/siren-action-behavior.html">
<link rel="import" href="../localize-behavior.html">
<link rel="import" href="../maybe.html">
<script>
	(function() {
		function CompletionTrackingMixin() {
			return class extends Polymer.mixinBehaviors([
				D2L.PolymerBehaviors.Siren.EntityBehavior,
				D2L.PolymerBehaviors.Siren.SirenActionBehaviorImpl,
				D2L.PolymerBehaviors.Sequences.LocalizeBehavior
			],
			Polymer.Element
			) {
				static get properties() {
					return {
						_completionEntity: {
							type: Object
						},
						_failedCompletion: {
							type: Object
						},
						_skipCompletion: {
							type: Boolean,
							computed: '_isImpersonating(token)'
						}
					};
				}

				finishCompletion() {
					this._fireToastEvent();

					if (!this._completionEntity || this._skipCompletion) {
						return;
					}

					this._performCompletion(this._completionEntity, 'finish-view-activity');
					this._completionEntity = null;
				}

				startCompletion() {
					if (this._skipCompletion) {
						return;
					}

					this._performCompletion(this.entity, 'view-activity-duration')
						.then(completion => this._completionEntity = completion)
						.catch(entity => this._failedCompletion = entity);
				}

				_performCompletion(entity, actionName) {
					return new Promise((resolve, reject) => {
						const action = Maybe.of(entity)
							.chain(
								e => e.getSubEntityByClass('activity'),
								a => a.getActionByName(actionName),
							);

						if (action.isNothing()) {
							return reject(entity, 'no action found');
						}

						// DEBUG WITH console.log('performing completion action', actionName, 'on', entity.properties.title);
						return this.performSirenAction(action.value)
							.then(resolve);
					});
				}

				_isImpersonating(token) {
					try {
						const payload = token.split('.')[1];
						const b64 = payload
							.replace(/-/g, '+')
							.replace(/_/g, '/');
						const jwt = JSON.parse(atob(b64));
						return jwt.hasOwnProperty('actualsub') &&
							jwt.hasOwnProperty('sub') &&
							jwt.actualsub !== jwt.sub;
					} catch (e) {
						return false;
					}
				}

				_fireToastEvent() {
					const href = Maybe.of(this._failedCompletion)
						.chain(
							e => e.getSubEntityByClass('activity'),
							a => a.getLinkByRel('about'),
							a => a.href
						).value;

					if (!href) {
						this._failedCompletion = null;
						return;
					}

					const notifyActivityTypes = [
						'dropbox',
						'quiz',
						'discuss'
					];

					if (notifyActivityTypes.some(t => href.includes(t))) {
						const event = new CustomEvent('toast', {
							detail: {
								message: 'There was more to do in the last activity.',
								name: this._failedCompletion.properties.title,
								url: this._failedCompletion.getLinkByRel('self').href
							},
							bubbles: true,
							composed: true,
						});
						window.dispatchEvent(event);
					}
					this._failedCompletion = null;
				}
			};
		}

		window.D2L = window.D2L || {};
		window.D2L.Polymer = window.D2L.Polymer || {};
		window.D2L.Polymer.Mixins = window.D2L.Polymer.Mixins || {};
		window.D2L.Polymer.Mixins.Sequences = window.D2L.Polymer.Mixins.Sequences || {};
		window.D2L.Polymer.Mixins.Sequences.CompletionTrackingMixin = CompletionTrackingMixin;
	})();
</script>
