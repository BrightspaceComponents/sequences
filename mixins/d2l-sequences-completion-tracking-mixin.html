<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-polymer-siren-behaviors/store/entity-behavior.html">
<link rel="import" href="../../d2l-polymer-siren-behaviors/store/siren-action-behavior.html">
<link rel="import" href="../localize-behavior.html">
<script>
	(function() {
		function CompletionTrackingMixin() {
			return class extends Polymer.mixinBehaviors([
				D2L.PolymerBehaviors.Siren.EntityBehavior,
				D2L.PolymerBehaviors.Siren.SirenActionBehaviorImpl,
				D2L.PolymerBehaviors.Sequences.LocalizeBehavior
			],
			Polymer.Element
			) {
				static get properties() {
					return {
						_completionEntity: {
							type: Object
						},
						_skipCompletion: {
							type: Boolean,
							computed: '_isImpersonating(token)'
						}
					};
				}

				finishCompletion() {
					if (!this._completionEntity || this._skipCompletion) {
						return;
					}

					this._performCompletion(this._completionEntity, 'finish-view-activity');
					this._completionEntity = null;
				}

				startCompletion() {
					if (this._skipCompletion) {
						return;
					}

					this._performCompletion(this.entity, 'view-activity-duration')
						.then(completion => this._completionEntity = completion)
						.catch(() => {});
				}

				_performCompletion(entity, actionName) {
					return new Promise((resolve, reject) => {
						const activitySubEntity = entity.getSubEntityByClass('activity');
						if (!activitySubEntity) {
							return reject('no activity subentity found');
						}

						const action = activitySubEntity.getActionByName(actionName);
						if (!action) {
							return reject('no action found');
						}

						// DEBUG WITH console.log('performing completion action', actionName, 'on', entity.properties.title);
						return this.performSirenAction(action)
							.then(resolve);
					});
				}

				_isImpersonating(token) {
					try {
						const payload = token.split('.')[1];
						const b64 = payload
							.replace(/-/g, '+')
							.replace(/_/g, '/');
						const jwt = JSON.parse(atob(b64));
						return jwt.hasOwnProperty('actualsub') &&
							jwt.hasOwnProperty('sub') &&
							jwt.actualsub !== jwt.sub;
					} catch (e) {
						return false;
					}
				}
			};
		}

		window.D2L = window.D2L || {};
		window.D2L.Polymer = window.D2L.Polymer || {};
		window.D2L.Polymer.Mixins = window.D2L.Polymer.Mixins || {};
		window.D2L.Polymer.Mixins.Sequences = window.D2L.Polymer.Mixins.Sequences || {};
		window.D2L.Polymer.Mixins.Sequences.CompletionTrackingMixin = CompletionTrackingMixin;
	})();
</script>
