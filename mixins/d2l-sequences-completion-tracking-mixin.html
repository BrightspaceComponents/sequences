<link rel="import" href="../../polymer-siren-mixins/siren-action-mixin.html">
<script>
	(function() {
		function CompletionTrackingMixin(superClass) {
			return class extends D2L.Polymer.Mixins.SirenActionMixin(superClass) {
				static get properties() {
					return {
						_completionEntity: {
							type: Object
						},
						_skipCompletion: {
							type: Boolean,
							computed: '_isImpersonating(token)'
						}
					};
				}

				finishCompletion() {
					if (!this._completionEntity || this._skipCompletion) {
						return;
					}

					this._performCompletion(this._completionEntity, 'finish-view-activity');
					this._completionEntity = null;
				}

				startCompletion() {
					if (this._skipCompletion) {
						return;
					}

					this._performCompletion(this.entity, 'view-activity-duration')
						.then(completion => this._completionEntity = completion);
				}

				_performCompletion(entity, actionName) {
					const activitySubEntity = entity.getSubEntityByClass('activity');
					if (!activitySubEntity) {
						return null;
					}

					const action = activitySubEntity.getActionByName(actionName);
					if (!action) {
						return null;
					}

					// DEBUG WITH console.log('performing completion action', actionName, 'on', entity.properties.title);
					// TODO: move the parse step to siren-action-mixin?  Do we want plain data in this siren world?
					return this.performSirenAction(action)
						.then(data => D2L.Hypermedia.Siren.Parse(data));
				}

				_isImpersonating(token) {
					try {
						const payload = token.split('.')[1];
						const b64 = payload
							.replace(/-/g, '+')
							.replace(/_/g, '/');
						const jwt = JSON.parse(atob(b64));
						return jwt.hasOwnProperty('actualsub') &&
							jwt.hasOwnProperty('sub') &&
							jwt.actualsub !== jwt.sub;
					} catch (e) {
						return false;
					}
				}
			};
		}

		window.D2L = window.D2L || {};
		window.D2L.Polymer = window.D2L.Polymer || {};
		window.D2L.Polymer.Mixins.Sequences = window.D2L.Polymer.Mixins.Sequences || {};
		window.D2L.Polymer.Mixins.Sequences.CompletionTrackingMixin = CompletionTrackingMixin;
	})();
</script>
