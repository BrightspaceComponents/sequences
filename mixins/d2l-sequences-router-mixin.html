<link rel="import" href="../../polymer/lib/utils/debounce.html">
<link rel="import" href="../components/d2l-sequences-content-error.html">
<script>
	(function() {
		function RouterMixin(getEntityType) {
			return class extends Polymer.TemplateStamp(
				Polymer.mixinBehaviors([D2L.PolymerBehaviors.Siren.EntityBehavior],	Polymer.Element)
			) {
				static get properties() {
					return {
						href: {
							type: String,
							reflectToAttribute: true,
							notify: true
						},
						_contentType: {
							type: String
						},
						_contentElement: {
							type: Object
						},
						_debouncer: {
							type: Object
						},
						_hrefUpdated: {
							type: Function
						},
						error: {
							type: Boolean,
							value: false
						}
					};
				}

				static get observers() {
					return ['_render(entity, error)'];
				}

				connectedCallback() {
					super.connectedCallback();
					this._hrefUpdated = this.addEventListener('hrefUpdated', ({detail}) => {
						this.href = detail.href;
					});
					this._D2lErrorListener = window.addEventListener('message', (event) => {
						if (event.data.type === 'd2l-error') {
							this.error = true;
						}
					});
				}

				disconnectedCallback() {
					super.disconnectedCallback();
					this.removeEventListener('hrefUpdated', this._hrefUpdated);
					this.removeEventListener('message', this._D2lErrorListener);
				}

				_render(entity, error) {
					getEntityType = getEntityType.bind(this);
					this._debouncer = Polymer.Debouncer.debounce(
						this._debouncer,
						Polymer.Async.timeOut.after(20),
						() => {
							let entityType = getEntityType(entity);
							if (error) {
								entityType = D2LSequencesContentError.is;
							}
							if (
								(entity &&
								(!this._contentElement || this._contentElement.href !== this.href)
								) || error
							) {
								this.error = false;
								const nodeTemplate = Polymer.DomModule.import(entityType, 'template');
								const contentElement = document.createElement(entityType);
								contentElement.appendChild(this._stampTemplate(nodeTemplate));

								if (this._contentElement) {
									this.shadowRoot.removeChild(this._contentElement);
								}

								this._contentElement = contentElement;
								this._contentType = entityType;

								this.shadowRoot.appendChild(this._contentElement);
								this._contentElement.href = this.href;
								this._contentElement.token = this.token;
							}
						}
					);
				}
			};
		}

		window.D2L = window.D2L || {};
		window.D2L.Polymer = window.D2L.Polymer || {};
		window.D2L.Polymer.Mixins = window.D2L.Polymer.Mixins || {};
		window.D2L.Polymer.Mixins.Sequences = window.D2L.Polymer.Mixins.Sequences || {};
		window.D2L.Polymer.Mixins.Sequences.RouterMixin = RouterMixin;
	})();
</script>
